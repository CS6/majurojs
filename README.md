# Savannah Builder

Savannah Builder is an open data platform. Users select a neighborhood or draw a custom area to extract buildings. They then can color-code, annotate, and describe each building, before creating a static site by forking this repo and adding their JSON data through Github's web interface.

The objective is to develop custom maps based on cities' public data, without leaving the web browser or introducing command line tools.

Code for interactive maps and the neighborhood file server are both open source.

# How to create your project

Step 1: Go to <a href="http://Savannah-Builder.heroku.com" target="_blank">Savannah-Builder.heroku.com</a>.

Step 2: Draw a polygon around your neighborhood ( using Leaflet.js polygon editing tools ).

<img src="http://i.imgur.com/U9uW5.png"/>

Step 3: Click the "Web Map" link to load buildings into an interactive <a href="http://savannah-builder.herokuapp.com/timeline?customgeo=50bc6eb9c446eb0200007455">map editor</a>.

Step 4: Interact with any building to add a photo, description, or color-coding.

<img src="http://i.imgur.com/566W8.png"/>

<img src="http://i.imgur.com/WmhxI.png"/>

Step 5: Download your custom map as KML (for Google Earth) and GeoJSON (for Github Pages).

<img src="http://i.imgur.com/OggY1.png"/>

<strong>You've got your map! Continue to put it on Github Pages:</strong>

Step 6: Fork this repo to your Github account. A sample map will appear at <a href="http://mapmeld.github.com/savannah-builder">USERNAME.github.com/savannah-builder</a>
<br/>
( If you don't have a Github account - join! It's free. )

Step 7: Using Github's online editor, paste your map's GeoJSON into the mybuild.geojson file.  Save changes.

# How to create a 3D View

Rendering 3D buildings with D3.js and three.js is an option for users of Firefox, Chrome, and Opera. Adapted from <a href="https://github.com/bmount">Brian Mount</a>'s original <a href="http://b.aguacat.es/anatine/_design/funbun/index.html">3D GeoJSON map</a>.

<img src="http://i.imgur.com/aWWvI.png"/>

A 3D View is available on <a href="http://savannah-builder.herokuapp.com">SavannahBuilder</a> or at <em>USERNAME.github.com/savannah-builder/3d</em> after you fork this repo.

<strong>Customization</strong>: Use Github's online editing to set /3d/3dscene.js to the center of your map.

<strong>Tips</strong>: Use arrow keys to pan, < and > to zoom, d and x to tilt, z and s to roll.

# Server

Custom neighborhood datasets are generated by a fork of <a href="https://github.com/codeforamerica/geodata-checkout">GeoData Checkout</a>, using a node.js server and MongoDB database.

KML and JSON downloads are provided with HTML5 BlobBuilder and FileSaver APIs, or by Eli Grey's <a href="https://github.com/eligrey/BlobBuilder.js">BlobBuilder.js</a> and <a href="https://github.com/eligrey/FileSaver.js">FileSaver.js</a>.

## About Poang

Poang ([github](https://github.com/BeyondFog/Poang)) is a Node.js/MongoDB app built using the [Express](http://expressjs.com/) framework. Poang uses [Everyauth](http://everyauth.com/) for local authentication, [Mongoose-Auth](https://github.com/bnoguchi/mongoose-auth) to connect Everyauth to MongoDB (and [Mongoose](http://mongoosejs.com/) as the ODM) for account persistence, and [Connect-Mongo](https://github.com/kcbanner/connect-mongo) as a session store. Most of the code in app.js was generated by Express and all of the code in auth.js after the Comment schema is straight from the Mongoose-Auth docs.

For testing, Poang uses the [Mocha](http://visionmedia.github.com/mocha/) test framework, [should](https://github.com/visionmedia/should.js) for assertions, [Sinon.JS](http://sinonjs.org/) for mocks & stubs, and [Zombie.js](http://zombie.labnotes.org/) for lightweight integration testing.

For more details, please see BeyondFog's [blog post](http://blog.beyondfog.com/?p=222) that walks through the various tests in Poang.

## About MongoDB

MongoDB is a NoSQL database which supports <a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing">geospatial queries</a>. The drawn polygon is saved as a CustomGeo, and its points are used to make this query:

    timepoint.TimePoint.find( {
      ll: {
        "$within": {
          "$polygon": poly
        }
      }
    })

## Server Setup

1) Do a git clone:

    git clone git://github.com/mapmeld/savannah-builder.git
    
2) cd into the project directory and then install the necessary node modules:

    npm install -d

3) start up MongoDB if it's not already running:
  
    mongod --noprealloc --nojournal
    
4) start the node process:

    node app.js

5) add a geospatial index to the "ll" field in your MongoDB settings

### Deploying to Heroku

    heroku create APP_NAME
    git push heroku master

After you have created a new app on Heroku and pushed the code via git, you will need to use the Heroku Toolbelt from your command line to add the free MongoLab starter addon:

    heroku addons:add mongolab:starter

Go to Heroku, click on Apps and then on this app's Addons. On the MongoLab admin panel, make sure there is a geospatial index to the "ll" field


### Uploading data

POST each of your polygons to /timeline using a script such as savannahbuild.py (included in the repo).

The POST body should include these variables:

* lat = center latitude
* lng = center longitude
* points = vertices in string with format lng1|lat1||lng2|lat2